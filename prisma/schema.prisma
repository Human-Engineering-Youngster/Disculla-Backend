// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum GroupMemberStatus {
  invited
  deleted
  active
  left
  block
}

enum ChannelType {
  chat
  discussion
}

enum MessageType {
  normal
  thread
  reply
  system
}

enum MessageStatus {
  normal
  deleted
  edited
}

enum TopicStatus {
  ready
  active
  stopped
  closed
}

enum AlertLevel {
  none
  info
  notice
  warning
  critical
}

// Models
model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkId   String   @unique @map("clerk_id")
  name      String
  avatarUrl String   @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  groupMembers  GroupMember[]
  ownedChannels Channel[]
  sentMessages  Message[]

  @@index([clerkId])
  @@index([createdAt])
  @@map("users")
}

model Group {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  members  GroupMember[]
  channels Channel[]

  @@index([createdAt])
  @@map("groups")
}

model GroupMember {
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId   String             @map("group_id") @db.Uuid
  userId    String             @map("user_id") @db.Uuid
  status    GroupMemberStatus
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId, userId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("group_members")
}

model Channel {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId     String      @map("owner_id") @db.Uuid
  groupId     String      @map("group_id") @db.Uuid
  name        String
  channelType ChannelType @map("channel_type")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  owner    User      @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  messages Message[]
  minutes  Minute[]
  topics   Topic[]

  @@index([groupId])
  @@index([ownerId])
  @@index([channelType])
  @@index([createdAt])
  @@map("channels")
}

model Message {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId String        @map("channel_id") @db.Uuid
  senderId  String        @map("sender_id") @db.Uuid
  parentId  String?       @map("parent_id") @db.Uuid
  content   String
  type      MessageType
  status    MessageStatus
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  channel Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender  User      @relation(fields: [senderId], references: [id], onDelete: Restrict)
  parent  Message?  @relation("MessageReplies", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  replies Message[] @relation("MessageReplies")

  @@index([channelId])
  @@index([senderId])
  @@index([parentId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([channelId, createdAt])
  @@map("messages")
}

model Minute {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId  String   @map("channel_id") @db.Uuid
  content    String
  conclusion String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([createdAt])
  @@map("minutes")
}

model Topic {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId   String      @map("channel_id") @db.Uuid
  title       String
  description String
  status      TopicStatus
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  channel        Channel          @relation(fields: [channelId], references: [id], onDelete: Cascade)
  debateAnalyses DebateAnalysis[]

  @@index([channelId])
  @@index([status])
  @@index([createdAt])
  @@index([channelId, status])
  @@map("topics")
}

model DebateAnalysis {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  topicId    String     @map("topic_id") @db.Uuid
  content    String
  isSolved   Boolean    @map("is_solved")
  alertLevel AlertLevel @map("alert_level")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  topic           Topic           @relation(fields: [topicId], references: [id], onDelete: Cascade)
  debateSummaries DebateSummary[]

  @@index([topicId])
  @@index([isSolved])
  @@index([alertLevel])
  @@index([createdAt])
  @@index([topicId, alertLevel])
  @@map("debate_analyses")
}

model DebateSummary {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  debateAnalysisId String   @map("debate_analysis_id") @db.Uuid
  summary          String
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  debateAnalysis DebateAnalysis @relation(fields: [debateAnalysisId], references: [id], onDelete: Cascade)

  @@index([debateAnalysisId])
  @@index([createdAt])
  @@map("debate_summaries")
}